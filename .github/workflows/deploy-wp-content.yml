name: Deploy wp-content

on:
  push:
    branches:
      - main
    paths:
      - "wp-content/**"
      - ".htaccess"
      - ".github/workflows/deploy-wp-content.yml"
  workflow_dispatch:
    inputs:
      force_full_deploy:
        description: 'Force full deployment (ignore git diff)'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    name: Upload wp-content to GoDaddy
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' }}
    env:
      REMOTE_PATH: ${{ secrets.GD_REMOTE_PATH }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed files
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.force_full_deploy }}" == "true" ]]; then
            echo "Full deployment requested"
            echo "mode=full" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Manual deployment - checking last commit"
            git diff --name-only HEAD~1 HEAD > changed_files.txt
            if [ -s changed_files.txt ]; then
              echo "mode=incremental" >> $GITHUB_OUTPUT
            else
              echo "No changes detected, deploying last commit changes"
              echo "mode=full" >> $GITHUB_OUTPUT
            fi
          else
            echo "Automatic deployment - checking changed files"
            git diff --name-only HEAD~1 HEAD > changed_files.txt
            echo "mode=incremental" >> $GITHUB_OUTPUT
          fi
          
          if [ -f changed_files.txt ]; then
            echo "Changed files:"
            cat changed_files.txt
          fi

      - name: Compress changed files
        run: |
          if [[ "${{ steps.changes.outputs.mode }}" == "full" ]]; then
            echo "Creating full deployment archive"
            tar -czf wp-content.tar.gz wp-content .htaccess
          else
            echo "Creating incremental deployment archive with changed files only"
            # Filter files to only include wp-content/** and .htaccess
            grep -E '^(wp-content/|\.htaccess)' changed_files.txt > deploy_files.txt || true
            
            if [ ! -s deploy_files.txt ]; then
              echo "No wp-content or .htaccess files changed, creating minimal archive"
              echo ".htaccess" > deploy_files.txt
            fi
            
            echo "Files to deploy:"
            cat deploy_files.txt
            
            # Create archive with only changed files
            tar -czf wp-content.tar.gz -T deploy_files.txt
          fi
          
          ls -lh wp-content.tar.gz

      - name: Upload archive via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.GD_SFTP_HOST }}
          username: ${{ secrets.GD_SFTP_USER }}
          password: ${{ secrets.GD_SFTP_PASSWORD }}
          port: ${{ secrets.GD_SFTP_PORT || 22 }}
          source: wp-content.tar.gz
          target: /tmp
          overwrite: true

      - name: Deploy on GoDaddy
        uses: appleboy/ssh-action@v0.1.10
        env:
          DEPLOY_MODE: ${{ steps.changes.outputs.mode }}
        with:
          host: ${{ secrets.GD_SFTP_HOST }}
          username: ${{ secrets.GD_SFTP_USER }}
          password: ${{ secrets.GD_SFTP_PASSWORD }}
          port: ${{ secrets.GD_SFTP_PORT || 22 }}
          envs: REMOTE_PATH,DEPLOY_MODE
          script: |
            set -euo pipefail

            REMOTE_PATH="${REMOTE_PATH:-html}"
            DEPLOY_MODE="${DEPLOY_MODE:-incremental}"
            ARCHIVE="/tmp/wp-content.tar.gz"
            DEPLOY_PATH="$REMOTE_PATH"
            BACKUP="/tmp/wp-content-backup-$(date +%Y%m%d%H%M%S).tar.gz"
            TMP_DIR="/tmp/wp-content-deploy-$(date +%Y%m%d%H%M%S)"

            echo "Deployment mode: $DEPLOY_MODE"

            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "Creating remote path $DEPLOY_PATH"
              mkdir -p "$DEPLOY_PATH"
            fi

            # Only create backup for full deployments
            if [[ "$DEPLOY_MODE" == "full" ]] && [ -d "$DEPLOY_PATH/wp-content" ]; then
              echo "Creating backup archive at $BACKUP"
              if ! tar -czf "$BACKUP" -C "$DEPLOY_PATH" wp-content 2>/tmp/wp-content-backup.log; then
                echo "Warning: backup encountered issues. Continuing deployment."
                cat /tmp/wp-content-backup.log || true
              fi
            fi

            echo "Preparing temporary extraction directory $TMP_DIR"
            mkdir -p "$TMP_DIR"

            echo "Extracting archive for staging"
            tar --no-same-owner --no-same-permissions -xzf "$ARCHIVE" -C "$TMP_DIR"
            
            echo "Extracted contents:"
            ls -la "$TMP_DIR"

            # Deploy wp-content files
            if [ -d "$TMP_DIR/wp-content" ]; then
              echo "wp-content directory found in archive"
              
              # Check if it's a full deployment or incremental
              if [[ "$DEPLOY_MODE" == "full" ]]; then
                echo "Full deployment: Using rsync with --delete"
                mkdir -p "$DEPLOY_PATH/wp-content"
                if ! rsync -rlv --delete \
                  --exclude='uploads/**' \
                  --exclude='mu-plugins/**' \
                  --exclude='cache/**' \
                  --exclude='upgrade/**' \
                  --exclude='uploads/cache/**' \
                  --exclude='advanced-cache.php' \
                  --exclude='object-cache.php' \
                  --exclude='.user.ini' \
                  --omit-dir-times \
                  --no-perms \
                  --no-owner \
                  --no-group \
                  --ignore-errors \
                  "$TMP_DIR/wp-content/" "$DEPLOY_PATH/wp-content/"; then
                  echo "Warning: rsync reported issues during sync."
                fi
              else
                echo "Incremental deployment: Copying changed files only"
                # For incremental updates, recursively copy all files preserving structure
                file_count=0
                find "$TMP_DIR/wp-content" -type f 2>/dev/null | while IFS= read -r file; do
                  rel_path="${file#$TMP_DIR/}"
                  dest="$DEPLOY_PATH/$rel_path"
                  mkdir -p "$(dirname "$dest")"
                  if cp -v "$file" "$dest"; then
                    echo "âœ“ Deployed: $rel_path"
                    file_count=$((file_count + 1))
                  else
                    echo "âœ— Failed: $rel_path"
                  fi
                done
                echo "Deployed $file_count file(s)"
              fi
            else
              echo "Warning: No wp-content directory found in archive"
            fi

            echo "Deploying .htaccess to root directory"
            if [ -f "$TMP_DIR/.htaccess" ]; then
              cp "$TMP_DIR/.htaccess" "$DEPLOY_PATH/.htaccess"
              echo ".htaccess deployed successfully"
            else
              echo "Note: .htaccess not found in archive (may not have changed)"
            fi

            echo "Cleaning up remote artifacts"
            rm -f "$ARCHIVE"
            rm -rf "$TMP_DIR"
            rm -f /tmp/wp-content-backup.log
            
            echo "Deployment completed successfully!"

      - name: Remove archive from runner
        run: rm -f wp-content.tar.gz

      - name: Flush WordPress and GoDaddy cache
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.GD_SFTP_HOST }}
          username: ${{ secrets.GD_SFTP_USER }}
          password: ${{ secrets.GD_SFTP_PASSWORD }}
          port: ${{ secrets.GD_SFTP_PORT || 22 }}
          script: |
            set -euo pipefail
            
            REMOTE_PATH="${REMOTE_PATH:-html}"
            DEPLOY_PATH="$REMOTE_PATH"
            
            echo "==========================================="
            echo "ðŸ”„ Flushing WordPress & GoDaddy Cache"
            echo "==========================================="
            
            # 1. Clear WordPress cache directories
            if [ -d "$DEPLOY_PATH/wp-content/cache" ]; then
              echo "Removing cache files from wp-content/cache/"
              find "$DEPLOY_PATH/wp-content/cache" -type f -delete 2>/dev/null || true
              echo "âœ… WordPress cache directory cleared"
            fi
            
            # 2. Clear object cache if exists
            if [ -f "$DEPLOY_PATH/wp-content/object-cache.php" ]; then
              echo "ðŸ“ Object cache file detected (Redis/Memcached)"
            fi
            
            # 3. Flush GoDaddy cache via WP-CLI
            if command -v wp &> /dev/null; then
              echo "WP-CLI detected, flushing all caches..."
              cd "$DEPLOY_PATH" || exit 1
              
              # Flush WordPress cache
              wp cache flush --allow-root 2>/dev/null && echo "âœ… WP cache flushed" || echo "âš ï¸  WP cache flush unavailable"
              
              # Delete all transients
              wp transient delete --all --allow-root 2>/dev/null && echo "âœ… Transients cleared" || echo "âš ï¸  Transient delete unavailable"
              
              # Flush GoDaddy cache using their built-in function
              # This uses the same mechanism as "GoDaddy Quick Link -> Flush cache" in wp-admin
              echo "Attempting to flush GoDaddy cache..."
              wp eval 'if (function_exists("ban_url")) { ban_url(home_url()); echo "âœ… GoDaddy cache flushed via ban_url()\n"; } else if (class_exists("GD_Cache") && method_exists("GD_Cache", "ban")) { GD_Cache::ban(home_url()); echo "âœ… GoDaddy cache flushed via GD_Cache::ban()\n"; } else { echo "âš ï¸  GoDaddy cache functions not available\n"; }' --allow-root 2>/dev/null || echo "âš ï¸  GoDaddy cache flush not available"
              
              echo "âœ… All caches flushed via WP-CLI"
            else
              echo "âš ï¸  WP-CLI not available"
            fi
            
            # 4. Touch wp-config.php to update timestamp
            if [ -f "$DEPLOY_PATH/wp-config.php" ]; then
              touch "$DEPLOY_PATH/wp-config.php"
              echo "âœ… wp-config.php timestamp updated"
            fi
            
            # 5. Alternative method: Delete GoDaddy's cache files directly if present
            if [ -d "$DEPLOY_PATH/.cache" ]; then
              echo "Found .cache directory, removing..."
              rm -rf "$DEPLOY_PATH/.cache" 2>/dev/null || true
              echo "âœ… .cache directory removed"
            fi
            
            echo "==========================================="
            echo "âœ… Cache flush completed!"
            echo "==========================================="
        continue-on-error: true
        env:
          REMOTE_PATH: ${{ secrets.GD_REMOTE_PATH }}

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: ${{ steps.changes.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.changes.outputs.mode }}" == "incremental" && -f deploy_files.txt ]]; then
            echo "### ðŸ“ Files Deployed" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat deploy_files.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ“¦ Full deployment completed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
