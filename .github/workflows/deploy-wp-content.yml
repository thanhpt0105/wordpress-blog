name: Deploy wp-content

on:
  push:
    branches:
      - main
    paths:
      - "wp-content/**"
      - ".htaccess"
      - ".github/workflows/deploy-wp-content.yml"
  workflow_dispatch:

jobs:
  deploy:
    name: Upload wp-content to GoDaddy
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' }}
    env:
      REMOTE_PATH: ${{ secrets.GD_REMOTE_PATH }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compress wp-content
        run: |
          tar -czf wp-content.tar.gz wp-content .htaccess

      - name: Upload archive via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.GD_SFTP_HOST }}
          username: ${{ secrets.GD_SFTP_USER }}
          password: ${{ secrets.GD_SFTP_PASSWORD }}
          port: ${{ secrets.GD_SFTP_PORT || 22 }}
          source: wp-content.tar.gz
          target: /tmp
          overwrite: true

      - name: Deploy on GoDaddy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.GD_SFTP_HOST }}
          username: ${{ secrets.GD_SFTP_USER }}
          password: ${{ secrets.GD_SFTP_PASSWORD }}
          port: ${{ secrets.GD_SFTP_PORT || 22 }}
          script: |
            set -euo pipefail

            REMOTE_PATH="${REMOTE_PATH:-html}"
            ARCHIVE="/tmp/wp-content.tar.gz"
            DEPLOY_PATH="$REMOTE_PATH"
            BACKUP="/tmp/wp-content-backup-$(date +%Y%m%d%H%M%S).tar.gz"
            TMP_DIR="/tmp/wp-content-deploy-$(date +%Y%m%d%H%M%S)"

            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "Creating remote path $DEPLOY_PATH"
              mkdir -p "$DEPLOY_PATH"
            fi

            if [ -d "$DEPLOY_PATH/wp-content" ]; then
              echo "Creating backup archive at $BACKUP"
              if ! tar -czf "$BACKUP" -C "$DEPLOY_PATH" wp-content 2>/tmp/wp-content-backup.log; then
                echo "Warning: backup encountered issues. Continuing deployment."
                cat /tmp/wp-content-backup.log || true
              fi
            fi

            echo "Preparing temporary extraction directory $TMP_DIR"
            mkdir -p "$TMP_DIR"

            echo "Extracting archive for staging"
            tar --no-same-owner --no-same-permissions -xzf "$ARCHIVE" -C "$TMP_DIR"

            echo "Syncing staged content into $DEPLOY_PATH/wp-content"
            mkdir -p "$DEPLOY_PATH/wp-content"
            # Never touch wp-content/uploads because media is managed on production.
            if ! rsync -rlv --delete \
              --exclude='uploads/**' \
              --exclude='mu-plugins/**' \
              --exclude='cache/**' \
              --exclude='upgrade/**' \
              --exclude='uploads/cache/**' \
              --exclude='advanced-cache.php' \
              --exclude='object-cache.php' \
              --exclude='.user.ini' \
              --omit-dir-times \
              --no-perms \
              --no-owner \
              --no-group \
              --ignore-errors \
              --size-only \
              "$TMP_DIR/wp-content/" "$DEPLOY_PATH/wp-content/"; then
              echo "Warning: rsync reported issues during sync. Review output above."
            fi

            echo "Deploying .htaccess to root directory"
            if [ -f "$TMP_DIR/.htaccess" ]; then
              cp "$TMP_DIR/.htaccess" "$DEPLOY_PATH/.htaccess"
              echo ".htaccess deployed successfully"
            else
              echo "Warning: .htaccess not found in archive"
            fi

            echo "Cleaning up remote artifacts"
            rm -f "$ARCHIVE"
            rm -rf "$TMP_DIR"
            rm -f /tmp/wp-content-backup.log

      - name: Remove archive from runner
        run: rm -f wp-content.tar.gz
